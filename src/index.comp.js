import CreateDivFnc from"./utils/createDiv.js";import{ProbFnc}from"./utils/prob.js";import msg from"./utils/messages.js";import{Language as lang}from"./utils/language.js";import updateCanvas from"./utils/updateCanvas.js";import updateProps12 from"./utils/updateProps12.js";const htmlEl=document.getElementsByTagName("html")[0],style=window.getComputedStyle(htmlEl,null).getPropertyValue("font-size"),fontSize=parseFloat(style),lockedDiv=document.querySelector(".locked"),lights=document.querySelector(".lights");let counter=0,countError=0,clickLockedDiv=e=>{counter>=5?(console.log("Go ahead with play"),location.href="info.html"):console.log("Not enought good prob!")};lockedDiv.addEventListener("click",clickLockedDiv),htmlEl.style.fontSize=Math.floor(Math.min(window.innerWidth/768*150,200))+"%";let canvas=document.getElementById("canvasId"),ctx=canvas.getContext("2d");canvas.width=window.innerWidth,canvas.height=window.innerHeight,window.addEventListener("resize",(function(e){htmlEl.style.fontSize=Math.floor(Math.min(window.innerWidth/768*150,200))+"%",canvas.width=window.innerWidth,canvas.height=window.innerHeight,updateCanvas(ctx,images,window.innerWidth,window.innerHeight)}));const language=navigator.language||navigator.userLanguage;let page,menuList;const updateLanguage=()=>{"fr-CA"===language?(page=lang.LanguageFr.page(),menuList=lang.LanguageFr.menu()):"en-US"===language&&(page=lang.LanguageUs.page(),menuList=lang.LanguageUs.menu())};"fr-CA"===language?(page=lang.LanguageFr.page(),menuList=lang.LanguageFr.menu()):"en-US"===language&&(page=lang.LanguageUs.page(),menuList=lang.LanguageUs.menu());const formDiv=CreateDivFnc({classes:["step-next","step-00","formDiv"],step:page.form}),probTxt=CreateDivFnc({classes:["step-next","step-0","probDiv"],step:page.decompose}),etape_1=CreateDivFnc({classes:["step-next","step-1"],step:page.step1}),etape_2=CreateDivFnc({classes:["step-next","step-2"],step:page.step2}),etape_3=CreateDivFnc({classes:["step-next","step-3"],step:page.step3}),formButton=CreateDivFnc({classes:["step-next","step-button"],step:""}),info=document.querySelector(".info"),about=document.querySelector(".about"),infoClick=document.querySelector(".info-click"),aboutClick=document.querySelector(".about-click"),checkBox=document.querySelector(".toggler"),divBtn=document.createElement("div"),btn=document.createElement("button"),step1DivMsg=document.createElement("div"),step2DivMsg=document.createElement("div"),step3DivMsg=document.createElement("div"),nextProbMsg=document.createElement("div"),heading=document.createElement("div"),subAll=document.querySelectorAll(".sub-menu-div"),subItems=document.querySelectorAll(".sub-menu"),formsClickable=document.querySelectorAll(".has-sub-menu"),app=document.querySelector(".root");divBtn.classList.add("divBtn"),btn.innerHTML=page.button,divBtn.append(btn);let step1=app.querySelector(".step-next.step-1"),step2=document.querySelector(".step-next.step-2"),step3=document.querySelector(".step-next.step-3");console.log("step 1=",step1);let formsArr=["(x+b<sub>1</sub>)(x+b<sub>2</sub>)","(a<sub>1</sub>x+b<sub>1</sub>)(a<sub>2</sub>x+b<sub>2</sub>)","(x<sup>n</sup>+b<sub>1</sub>)(x<sup>n</sup>+b<sub>2</sub>)","(a<sub>1</sub>x<sup>n</sup>+b<sub>1</sub>)(a<sub>2</sub>x<sup>n</sup>+b<sub>2</sub>)"],formActive=0;document.title=page.title,document.querySelector(".menu-item.info-click").innerHTML=menuList.menu0,document.querySelector(".menu-item.about-click").innerHTML=menuList.menu1;let props={max:6,numVar:["x"],nbrTerms:2,degArr:[1,0],anPos:!0},props1={anPos:!0,maxA:1,max:11},props2={anPos:!0,maxA:1,max:11},props12={},prob=ProbFnc(props);prob.genProb(props1,props2);let menuActive={menu:"",subMenu:""},menu=localStorage.getItem("menu");menuActive=JSON.parse(menu),console.log("Local storage=",menuActive);let updateAllDivs=()=>{probTxt.divEditor.innerHTML=prob.polyObj.finalHtmlReduce,formDiv.divEditor.innerHTML=formsArr[formActive],etape_1.editor.resetDiv(),etape_2.editor.resetDiv(),etape_3.editor.resetDiv(),etape_1.divEditor.innerHTML=prob.step1Html[0],etape_2.divEditor.innerHTML=prob.step2Html[0],etape_3.divEditor.innerHTML=prob.step3Html[0],etape_1.divEditor.focus(),etape_1.editor.setCaretPosition(0)},updateMenuActive=e=>{let t=e.menu,s=e.subMenu;"form-0"===t?formActive=0:"form-1"===t?formActive=1:"form-2"===t?formActive=2:"form-3"===t&&(formActive=3),subItems.forEach((e=>{e.classList.remove("active"),e.classList[1]===t&&e.classList[2]===s&&(e.classList.add("active"),checkBox.checked&&(checkBox.checked=!1))})),props12=updateProps12(e),props1=props12.props1,props2=props12.props2,prob.genProb(props1,props2)};menuActive&&updateMenuActive(menuActive),formDiv.divEditor.contentEditable=!1,formDiv.divEditor.innerHTML=formsArr[formActive],formButton.divEditor.contentEditable,probTxt.divEditor.contentEditable=!1,probTxt.divEditor.innerHTML=prob.polyObj.finalHtmlOrder,infoClick.addEventListener("click",(()=>{info.classList.toggle("show")})),aboutClick.addEventListener("click",(()=>{about.classList.toggle("show")})),step1DivMsg.classList.add("message"),step1DivMsg.classList.add("hidden"),step2DivMsg.classList.add("message"),step2DivMsg.classList.add("hidden"),step3DivMsg.classList.add("message"),step3DivMsg.classList.add("hidden"),nextProbMsg.classList.add("message"),nextProbMsg.classList.add("hidden"),nextProbMsg.classList.add("success"),heading.textContent="My AI exerciser",heading.classList.add("heading");let imagesPromise=[],images=[],nbrImage=9;for(let e=0;e<nbrImage;e+=1)imagesPromise.push(new Promise(((t,s)=>{let i=`images/image_${e}.png`;images[e]=new Image,images[e].src=i,images[e].addEventListener("load",(function(){t(!0)}))})));Promise.all(imagesPromise).then((e=>{updateCanvas(ctx,images,window.innerWidth,window.innerHeight)})),console.log("prob is = ",prob);let updateSteps=e=>{if(void 0===e.target)return;if("btn"===e.target){if(prob.step_1_done&&prob.step_2_done&&prob.step_3_done)return 0===countError?(counter+=1,lockedDiv.innerHTML=counter):counter>0&&(counter-=1,lockedDiv.innerHTML=counter),counter>=5?(lockedDiv.style.backgroundImage="url('./images/cadenas_open_200x400.png')",lockedDiv.style.cursor="pointer"):(lockedDiv.style.backgroundImage="url('./images/cadenas_close_200x400.png')",lockedDiv.style.cursor=""),countError=0,updateCanvas(ctx,images,window.innerWidth,window.innerHeight),props12=updateProps12(menuActive),props1=props12.props1,props2=props12.props2,prob.genProb(props1,props2),nextProbMsg.innerHTML=msg.success(),nextProbMsg.classList.remove("hidden"),setTimeout((()=>{nextProbMsg.classList.add("hidden")}),3e3),probTxt.divEditor.innerHTML=prob.polyObj.finalHtmlReduce,etape_1.editor.resetDiv(),etape_2.editor.resetDiv(),etape_3.editor.resetDiv(),etape_1.editor.setCaretPosition(0),void updateAllDivs();if(!prob.step_1_done)return void etape_1.editor.setCaretPosition(0);if(!prob.step_2_done)return void etape_2.editor.setCaretPosition(0);if(!prob.step_3_done)return void etape_3.editor.setCaretPosition(0)}step1DivMsg.innerHTML="",step1DivMsg.classList.add("hidden"),step1DivMsg.classList.remove("error"),step1DivMsg.classList.remove("warning"),step2DivMsg.innerHTML="",step2DivMsg.classList.add("hidden"),step2DivMsg.classList.remove("error"),step2DivMsg.classList.remove("warning"),step3DivMsg.innerHTML="",step3DivMsg.classList.add("hidden"),step3DivMsg.classList.remove("error"),step3DivMsg.classList.remove("warning");let t="",s="";if(s=e.target,"step-1"===s){if(t=etape_1.editor.getHtmlForm(),""===t)return void etape_1.editor.setCaretPosition(0)}else if("step-2"===s){if(t=etape_2.editor.getHtmlForm(),""===t)return void etape_2.editor.setCaretPosition(0)}else{if("step-3"!==s)return void console.log("error in blur method==================");if(t=etape_3.editor.getHtmlForm(),""===t)return void etape_3.editor.setCaretPosition(0)}let i=prob.analyseStudentInput(t,s);if(""===i.error){let e=i.result.find;if("step-1"===e?(prob.step_1_done=!0,etape_1.divEditor.innerHTML=i.studentObj.chainHtml):"step-2"===e?(prob.step_2_done=!0,etape_2.divEditor.innerHTML=i.studentObj.chainHtml):"step-3"===e&&(prob.step_3_done=!0,etape_3.divEditor.innerHTML=i.studentObj.chainHtml),e===s?prob.step_1_done?prob.step_2_done?prob.step_3_done?btn.focus():etape_3.editor.setCaretPosition(0):etape_2.editor.setCaretPosition(0):etape_1.editor.setCaretPosition(0):"step-1"===s?(etape_1.divEditor.innerHTML="",etape_1.editor.setCaretPosition(0)):"step-2"===s?(etape_2.divEditor.innerHTML="",etape_2.editor.setCaretPosition(0)):"step-3"===s&&(etape_3.divEditor.innerHTML="",etape_3.editor.setCaretPosition(0)),""!==i.msg)if(lights.style.backgroundImage="url('./images/lights_yellow_on.png')",setTimeout((()=>{lights.style.backgroundImage="url('./images/lights_all_off.png')"}),2e3),"step-1"===e)step1DivMsg.innerHTML=i.msg,step1DivMsg.classList.add("warning"),step1DivMsg.classList.remove("hidden");else if("step-2"===e)step2DivMsg.innerHTML=i.msg,step2DivMsg.classList.add("warning"),step2DivMsg.classList.remove("hidden");else{if("step-3"!==e)return void console.log("error in blur method==================");step3DivMsg.innerHTML=i.msg,step3DivMsg.classList.add("warning"),step3DivMsg.classList.remove("hidden")}else lights.style.backgroundImage="url('./images/lights_green_on.png')",setTimeout((()=>{lights.style.backgroundImage="url('./images/lights_all_off.png')"}),2e3)}else if(countError+=1,lights.style.backgroundImage="url('./images/lights_red_on.png')",setTimeout((()=>{lights.style.backgroundImage="url('./images/lights_all_off.png')"}),2e3),"step-1"===s)step1DivMsg.innerHTML=i.error,step1DivMsg.classList.add("error"),step1DivMsg.classList.remove("hidden"),etape_1.divEditor.focus();else if("step-2"===s)step2DivMsg.innerHTML=i.error,step2DivMsg.classList.add("error"),step2DivMsg.classList.remove("hidden"),etape_2.divEditor.focus();else{if("step-3"!==s)return void console.log("error in update click fnc ==================");step3DivMsg.innerHTML=i.error,step3DivMsg.classList.add("error"),step3DivMsg.classList.remove("hidden"),etape_3.divEditor.focus()}},clickDiv=e=>{let t=e.target.classList[1];"step-1"===t||("step-2"===t?prob.step_1_done||updateSteps({target:"step-1"}):"step-3"===t&&(prob.step_1_done?prob.step_2_done||updateSteps({target:"step-2"}):updateSteps({target:"step-1"})))};etape_1.divEditor.addEventListener("click",clickDiv),etape_2.divEditor.addEventListener("click",clickDiv),etape_3.divEditor.addEventListener("click",clickDiv);let onClickBtn=e=>{console.log("IN click button e=",e),prob.step_1_done?prob.step_2_done?prob.step_3_done||updateSteps({target:"step-3"}):updateSteps({target:"step-2"}):updateSteps({target:"step-1"}),updateSteps({target:"btn"})},onkeydown=e=>{step1DivMsg.innerHTML="",step1DivMsg.classList.add("hidden"),step1DivMsg.classList.remove("error"),step1DivMsg.classList.remove("warning"),step2DivMsg.innerHTML="",step2DivMsg.classList.add("hidden"),step2DivMsg.classList.remove("error"),step2DivMsg.classList.remove("warning"),step3DivMsg.innerHTML="",step3DivMsg.classList.add("hidden"),step3DivMsg.classList.remove("error"),step3DivMsg.classList.remove("warning"),"Enter"===e.key&&updateSteps({target:e.target.classList[1]})};document.body.addEventListener("keydown",onkeydown),btn.addEventListener("click",onClickBtn),etape_1.divEditor.innerHTML=prob.step1Html[0],etape_2.divEditor.innerHTML=prob.step2Html[0],etape_3.divEditor.innerHTML=prob.step3Html[0];let subMenuListener=e=>{let t=e.target.classList[1],s=e.target.classList[2];menuActive.menu=t,menuActive.subMenu=s,updateMenuActive(menuActive),updateAllDivs()},formListen=e=>{if("has-sub-menu"===e.target.classList[0]){subAll.forEach((e=>{e.classList.remove("active")})),formsClickable.forEach((e=>{e.classList.remove("active")})),e.target.classList.add("active");let t=e.target.querySelector(`.sub-menu-div.${e.target.classList[1]}`);null!=t&&t.classList.add("active")}};function addListernerForms(){subItems.forEach((e=>{e.addEventListener("click",subMenuListener)})),formsClickable.forEach((e=>{e.addEventListener("click",formListen)}))}addListernerForms(),app.append(formDiv.div,probTxt.div,etape_1.div,step1DivMsg,etape_2.div,step2DivMsg,etape_3.div,step3DivMsg,divBtn,nextProbMsg),etape_1.divEditor.focus(),etape_1.editor.setCaretPosition(0);