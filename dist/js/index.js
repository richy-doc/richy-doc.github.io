import CreateDivFnc from"../utils/createDiv.js";import{ProbFnc}from"../utils/prob.js";import msg from"../utils/messages.js";import{Language as lang}from"../utils/language.js";import updateCanvas from"../utils/updateCanvas.js";import updateProps12 from"../utils/updateProps12.js";import assets from"../utils/assetsmain.js";import makeSound from"../utils/makesound.js";const dqs=e=>document.querySelector(e),dqsa=e=>document.querySelectorAll(e),dce=e=>document.createElement(e),menu_wrap=dqs(".menu-wrap");let music,imagesToLoad=["./images/image_0.png","./images/image_1.png","./images/image_2.png","./images/image_3.png","./images/image_4.png","./images/image_5.png","./images/cadenas_close_200x400.png","./images/cadenas_open_200x400.png","./images/lights_all_off_200.png","./images/lights_green_on_200.png","./images/lights_red_on_200.png","./images/lights_yellow_on_200.png","./images/lights_all_on_200.png"],soundsToLoad=["./sounds/music.wav"],arrayToLoad=imagesToLoad.concat(soundsToLoad),waitVideo=document.querySelector("video"),wait=document.querySelector(".wait");function clgAsset(){console.log("Asset is =",assets),console.log("Asset is =",assets["./images/lights_red_on.png"]),console.log("Asset wav is =",assets["./sounds/music.wav"]),music=assets["./sounds/music.wav"],console.log("music actx state=",music.actx.state)}assets.load(arrayToLoad).then((()=>{setTimeout((()=>{showPage()}),8e3)})),music=assets["./sounds/music.wav"];const lights_red_on="url("+assets["./images/lights_red_on_200.png"].src+")",lights_all_off="url("+assets["./images/lights_all_off_200.png"].src+")",lights_green_on="url("+assets["./images/lights_green_on_200.png"].src+")",lights_yellow_on="url("+assets["./images/lights_yellow_on_200.png"].src+")",lights_all_on="url("+assets["./images/lights_all_on_200.png"].src+")",cadenas_open_200x400="url("+assets["./images/cadenas_open_200x400.png"].src+")",cadenas_close_200x400="url("+assets["./images/cadenas_close_200x400.png"].src+")",htmlEl=document.getElementsByTagName("html")[0],style=window.getComputedStyle(htmlEl,null).getPropertyValue("font-size"),fontSize=parseFloat(style),lockedDiv=dqs(".locked"),lights=dqs(".lights");let counter=0,countError=0;const nbrGoodProb=5;function setupMusic(){music.pause(),music.loop=!0,music.pan=-.8,music.volume=.3,music.play(),music.actx.resume().then((()=>{music.play()}))}lockedDiv.innerHTML="0/5";let clickLockedDiv=e=>{loadGameV2(),counter>=5&&window.open("game.html")};lockedDiv.addEventListener("click",clickLockedDiv),htmlEl.style.fontSize=Math.floor(Math.min(window.innerWidth/768*150,200))+"%";let canvas=document.getElementById("canvasId"),ctx=canvas.getContext("2d");canvas.width=window.innerWidth,canvas.height=window.innerHeight,window.addEventListener("resize",(function(e){htmlEl.style.fontSize=Math.floor(Math.min(window.innerWidth/768*150,200))+"%",canvas.width=window.innerWidth,canvas.height=window.innerHeight,updateCanvas(ctx,images,window.innerWidth,window.innerHeight)}));const language=navigator.language||navigator.userLanguage;let page,menuList;const updateLanguage=()=>{page=lang.LanguageFr.page(),menuList=lang.LanguageFr.menu()};page=lang.LanguageFr.page(),menuList=lang.LanguageFr.menu();const formDiv=CreateDivFnc({classes:["step-next","step-00","formDiv"],step:page.form}),probTxt=CreateDivFnc({classes:["step-next","step-0","probDiv"],step:page.decompose}),etape_1=CreateDivFnc({classes:["step-next","step-1"],step:page.step1}),etape_2=CreateDivFnc({classes:["step-next","step-2"],step:page.step2}),etape_3=CreateDivFnc({classes:["step-next","step-3"],step:page.step3}),formButton=CreateDivFnc({classes:["step-next","step-button"],step:""}),info=dqs(".info"),about=dqs(".about"),infoClick=dqs(".info-click"),aboutClick=dqs(".about-click"),checkBox=dqs(".toggler"),divBtn=dce("div"),btn=dce("button"),step1DivMsg=dce("div"),step2DivMsg=dce("div"),step3DivMsg=dce("div"),nextProbMsg=dce("div"),heading=dce("div"),subAll=dqsa(".sub-menu-div"),subItems=dqsa(".sub-menu"),formsClickable=dqsa(".has-sub-menu"),app=dqs(".root");divBtn.classList.add("divBtn"),btn.innerHTML=page.button,divBtn.append(btn);let formsArr=["(x+b<sub>1</sub>)(x+b<sub>2</sub>)","(a<sub>1</sub>x+b<sub>1</sub>)(a<sub>2</sub>x+b<sub>2</sub>)","(x<sup>n</sup>+b<sub>1</sub>)(x<sup>n</sup>+b<sub>2</sub>)","(a<sub>1</sub>x<sup>n</sup>+b<sub>1</sub>)(a<sub>2</sub>x<sup>n</sup>+b<sub>2</sub>)"],formActive=0;document.title=page.title,dqs(".menu-item.info-click").innerHTML=menuList.menu0,dqs(".menu-item.about-click").innerHTML=menuList.menu1;let props={max:6,numVar:["x"],nbrTerms:2,degArr:[1,0],anPos:!0},props1={anPos:!0,maxA:1,max:11},props2={anPos:!0,maxA:1,max:11},props12={},prob=ProbFnc(props);prob.genProb(props1,props2);let menuActive={menu:"form-0",subMenu:"item-0"},updateAllDivs=()=>{probTxt.divEditor.innerHTML=prob.polyObj.finalHtmlReduce,formDiv.divEditor.innerHTML=formsArr[formActive],etape_1.editor.resetDiv(),etape_2.editor.resetDiv(),etape_3.editor.resetDiv(),etape_1.divEditor.innerHTML=prob.step1Html[0],etape_2.divEditor.innerHTML=prob.step2Html[0],etape_3.divEditor.innerHTML=prob.step3Html[0],etape_1.divEditor.focus(),etape_1.editor.setCaretPosition(0)},updateMenuActive=e=>{let s=e.menu,t=e.subMenu;"form-0"===s?formActive=0:"form-1"===s?formActive=1:"form-2"===s?formActive=2:"form-3"===s&&(formActive=3),subItems.forEach((e=>{e.classList.remove("active"),e.classList[1]===s&&e.classList[2]===t&&(e.classList.add("active"),checkBox.checked&&(checkBox.checked=!1))})),props12=updateProps12(e),props1=props12.props1,props2=props12.props2,prob.genProb(props1,props2)};menuActive&&updateMenuActive(menuActive),formDiv.divEditor.contentEditable=!1,formDiv.divEditor.innerHTML=formsArr[formActive],formButton.divEditor.contentEditable,probTxt.divEditor.contentEditable=!1,probTxt.divEditor.innerHTML=prob.polyObj.finalHtmlOrder,infoClick.addEventListener("click",(()=>{info.classList.toggle("show")})),aboutClick.addEventListener("click",(()=>{about.classList.toggle("show")})),step1DivMsg.classList.add("message"),step1DivMsg.classList.add("hidden"),step2DivMsg.classList.add("message"),step2DivMsg.classList.add("hidden"),step3DivMsg.classList.add("message"),step3DivMsg.classList.add("hidden"),nextProbMsg.classList.add("message"),nextProbMsg.classList.add("hidden"),nextProbMsg.classList.add("success"),heading.textContent="My AI exerciser",heading.classList.add("heading");let imagesPromise=[],images=[],nbrImage=5;for(let e=0;e<=nbrImage;e+=1)images.push(assets[`./images/image_${e}.png`]);let updateSteps=e=>{if(void 0===e.target)return;if("btn"===e.target){if(prob.step_1_done&&prob.step_2_done&&prob.step_3_done)return 0===countError?(counter+=1,lockedDiv.innerHTML=counter+"/5"):counter>0&&(counter-=1,lockedDiv.innerHTML=counter+"/5"),counter>=5?(lockedDiv.style.backgroundImage=cadenas_open_200x400,lockedDiv.style.cursor="pointer"):(lockedDiv.style.backgroundImage=cadenas_close_200x400,lockedDiv.style.cursor=""),countError=0,updateCanvas(ctx,images,window.innerWidth,window.innerHeight),props12=updateProps12(menuActive),props1=props12.props1,props2=props12.props2,prob.genProb(props1,props2),nextProbMsg.innerHTML=msg.success(),nextProbMsg.classList.remove("hidden"),setTimeout((()=>{nextProbMsg.classList.add("hidden")}),3e3),probTxt.divEditor.innerHTML=prob.polyObj.finalHtmlReduce,etape_1.editor.resetDiv(),etape_2.editor.resetDiv(),etape_3.editor.resetDiv(),etape_1.editor.setCaretPosition(0),void updateAllDivs();if(!prob.step_1_done)return void etape_1.editor.setCaretPosition(0);if(!prob.step_2_done)return void etape_2.editor.setCaretPosition(0);if(!prob.step_3_done)return void etape_3.editor.setCaretPosition(0)}step1DivMsg.innerHTML="",step1DivMsg.classList.add("hidden"),step1DivMsg.classList.remove("error"),step1DivMsg.classList.remove("warning"),step1DivMsg.classList.remove("special"),step2DivMsg.innerHTML="",step2DivMsg.classList.add("hidden"),step2DivMsg.classList.remove("error"),step2DivMsg.classList.remove("warning"),step2DivMsg.classList.remove("special"),step3DivMsg.innerHTML="",step3DivMsg.classList.add("hidden"),step3DivMsg.classList.remove("error"),step3DivMsg.classList.remove("warning"),step3DivMsg.classList.remove("special");let s="",t="";if(t=e.target,"step-1"===t){if(s=etape_1.editor.getHtmlForm(),""===s)return void etape_1.editor.setCaretPosition(0)}else if("step-2"===t){if(s=etape_2.editor.getHtmlForm(),""===s)return void etape_2.editor.setCaretPosition(0)}else{if("step-3"!==t)return void console.log("error in blur method==================");if(s=etape_3.editor.getHtmlForm(),""===s)return void etape_3.editor.setCaretPosition(0)}let i=prob.analyseStudentInput(s,t);if(i.special)if(lights.style.backgroundImage=lights_all_on,setTimeout((()=>{lights.style.backgroundImage=lights_all_off}),2e3),"step-1"===t)step1DivMsg.innerHTML=i.special,step1DivMsg.classList.add("special"),step1DivMsg.classList.remove("hidden"),etape_1.divEditor.focus();else if("step-2"===t)step2DivMsg.innerHTML=i.special,step2DivMsg.classList.add("special"),step2DivMsg.classList.remove("hidden"),etape_2.divEditor.focus();else{if("step-3"!==t)return void console.log("error in update click fnc ==================");step3DivMsg.innerHTML=i.special,step3DivMsg.classList.add("special"),step3DivMsg.classList.remove("hidden"),etape_3.divEditor.focus()}else if(""===i.error){let e=i.result.find;if("step-1"===e?(prob.step_1_done=!0,etape_1.divEditor.innerHTML=i.studentObj.chainHtml):"step-2"===e?(prob.step_2_done=!0,etape_2.divEditor.innerHTML=i.studentObj.chainHtml):"step-3"===e&&(prob.step_3_done=!0,etape_3.divEditor.innerHTML=i.studentObj.chainHtml),e===t?prob.step_1_done?prob.step_2_done?prob.step_3_done?btn.focus():etape_3.editor.setCaretPosition(0):etape_2.editor.setCaretPosition(0):etape_1.editor.setCaretPosition(0):"step-1"===t?(etape_1.divEditor.innerHTML="",etape_1.editor.setCaretPosition(0)):"step-2"===t?(etape_2.divEditor.innerHTML="",etape_2.editor.setCaretPosition(0)):"step-3"===t&&(etape_3.divEditor.innerHTML="",etape_3.editor.setCaretPosition(0)),""!==i.msg)if(lights.style.backgroundImage=lights_yellow_on,setTimeout((()=>{lights.style.backgroundImage=lights_all_off}),2e3),"step-1"===e)step1DivMsg.innerHTML=i.msg,step1DivMsg.classList.add("warning"),step1DivMsg.classList.remove("hidden");else if("step-2"===e)step2DivMsg.innerHTML=i.msg,step2DivMsg.classList.add("warning"),step2DivMsg.classList.remove("hidden");else{if("step-3"!==e)return void console.log("error in blur method==================");step3DivMsg.innerHTML=i.msg,step3DivMsg.classList.add("warning"),step3DivMsg.classList.remove("hidden")}else lights.style.backgroundImage=lights_green_on,setTimeout((()=>{lights.style.backgroundImage=lights_all_off}),2e3)}else if(countError+=1,lights.style.backgroundImage=lights_red_on,setTimeout((()=>{lights.style.backgroundImage=lights_all_off}),2e3),"step-1"===t)step1DivMsg.innerHTML=i.error,step1DivMsg.classList.add("error"),step1DivMsg.classList.remove("hidden"),etape_1.divEditor.focus();else if("step-2"===t)step2DivMsg.innerHTML=i.error,step2DivMsg.classList.add("error"),step2DivMsg.classList.remove("hidden"),etape_2.divEditor.focus();else{if("step-3"!==t)return void console.log("error in update click fnc ==================");step3DivMsg.innerHTML=i.error,step3DivMsg.classList.add("error"),step3DivMsg.classList.remove("hidden"),etape_3.divEditor.focus()}},clickDiv=e=>{let s=e.target.classList[1];"step-1"===s||("step-2"===s?prob.step_1_done||updateSteps({target:"step-1"}):"step-3"===s&&(prob.step_1_done?prob.step_2_done||updateSteps({target:"step-2"}):updateSteps({target:"step-1"})))};etape_1.divEditor.addEventListener("click",clickDiv),etape_2.divEditor.addEventListener("click",clickDiv),etape_3.divEditor.addEventListener("click",clickDiv);let onClickBtn=e=>{prob.step_1_done?prob.step_2_done?prob.step_3_done?(step1DivMsg.innerHTML="",step1DivMsg.classList.add("hidden"),step1DivMsg.classList.remove("error"),step1DivMsg.classList.remove("warning"),step1DivMsg.classList.remove("special"),step2DivMsg.innerHTML="",step2DivMsg.classList.add("hidden"),step2DivMsg.classList.remove("error"),step2DivMsg.classList.remove("warning"),step2DivMsg.classList.remove("special"),step3DivMsg.innerHTML="",step3DivMsg.classList.add("hidden"),step3DivMsg.classList.remove("error"),step3DivMsg.classList.remove("warning"),step3DivMsg.classList.remove("special"),updateSteps({target:"btn"})):updateSteps({target:"step-3"}):updateSteps({target:"step-2"}):updateSteps({target:"step-1"})},onkeydown=e=>{step1DivMsg.innerHTML="",step1DivMsg.classList.add("hidden"),step1DivMsg.classList.remove("error"),step1DivMsg.classList.remove("warning"),step1DivMsg.classList.remove("special"),step2DivMsg.innerHTML="",step2DivMsg.classList.add("hidden"),step2DivMsg.classList.remove("error"),step2DivMsg.classList.remove("warning"),step2DivMsg.classList.remove("special"),step3DivMsg.innerHTML="",step3DivMsg.classList.add("hidden"),step3DivMsg.classList.remove("error"),step3DivMsg.classList.remove("warning"),step3DivMsg.classList.remove("special"),"Enter"===e.key&&updateSteps({target:e.target.classList[1]})};document.body.addEventListener("keydown",onkeydown),btn.addEventListener("click",onClickBtn),etape_1.divEditor.innerHTML=prob.step1Html[0],etape_2.divEditor.innerHTML=prob.step2Html[0],etape_3.divEditor.innerHTML=prob.step3Html[0];let subMenuListener=e=>{let s=e.target.classList[1],t=e.target.classList[2];menuActive.menu=s,menuActive.subMenu=t,updateMenuActive(menuActive),updateAllDivs()},formListen=e=>{if("has-sub-menu"===e.target.classList[0]){subAll.forEach((e=>{e.classList.remove("active")})),formsClickable.forEach((e=>{e.classList.remove("active")})),e.target.classList.add("active");let s=e.target.querySelector(`.sub-menu-div.${e.target.classList[1]}`);null!=s&&s.classList.add("active")}};function addListernerForms(){subItems.forEach((e=>{e.addEventListener("click",subMenuListener)})),formsClickable.forEach((e=>{e.addEventListener("click",formListen)}))}function showPage(){lockedDiv.style.backgroundImage=cadenas_close_200x400,lockedDiv.style.backgroundRepeat="no-repeat",lockedDiv.style.backgroundSize="100%",lights.style.backgroundImage=lights_all_off,lights.style.backgroundRepeat="no-repeat",lights.style.backgroundSize="100%",app.append(formDiv.div,probTxt.div,etape_1.div,step1DivMsg,etape_2.div,step2DivMsg,etape_3.div,step3DivMsg,divBtn,nextProbMsg),updateCanvas(ctx,images,window.innerWidth,window.innerHeight),etape_1.divEditor.focus(),etape_1.editor.setCaretPosition(0),waitVideo.pause(),waitVideo.currentTime=0,wait.style.display="none",menu_wrap.style.display="block"}function loadGame(){let e=menuActive.menu,s=menuActive.subMenu;window.open("game.html").onload=function(){this.menu=e,this.subMenu=s}}function loadGameV2(){let e=menuActive.menu,s=menuActive.subMenu,t=new URLSearchParams;t.append("menu",e),t.append("subMenu",s);window.open("game.html?"+t)}addListernerForms();