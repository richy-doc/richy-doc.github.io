import errors from"./errors.js";import msg from"./messages.js";import{PolynomeFnc}from"./polynome.js";import{resolveHtmlToObj,polyTermsToHtml,mulPolysTerms,copyPolyTerms,testStrangeChar,isPolysEquals,isPolysEquivalents,isPolysArrOpEquals,isPolysArrOpEquivalents,nbrNegativeSignPolyArrOp}from"./polyutils.js";import{isTermsEquivalent,isTermsEqual}from"./termUtils.js";const ProbFnc=r=>{r.anPos=r.anPos||!1,r.degArr=r.degArr||[1,0],r.nbrTerms=r.nbrTerms||2,r.maxA=r.maxA||1,r.randomDeg=r.randomDeg||!1,r.min=r.min||1,r.max=r.max||11,r.numVar=r.numVar||["x"],r.excludeMultiples=r.excludeMultiples||[],r.mustExclude=void 0===r.mustExclude||r.mustExclude;let e,l,o,t,n,s,i,f=r.numVar[0],p=(r.divMsg,{}),m=[],a=[],u=[],d=[],h=[],c=[],H=!1,O=!1,g=!1,y=!1;return p.genProb=function(_,b){f=_.numVar&&void 0!==_.numVar[0]?_.numVar[0]:r.numVar[0],e=PolynomeFnc({...r,..._}),l=PolynomeFnc({...r,...b}),m=[],a=[],u=[],d=[],h=[],c=[],H=!1,O=!1,g=!1,y=!1,o=e.poly,t=l.poly;let v="("+polyTermsToHtml(o)+")("+polyTermsToHtml(t)+")";n=resolveHtmlToObj(v),function(){let r=null,e=null,l=o[0].coeff,n=t[0].coeff,f=o[1].coeff,p=t[1].coeff;s=l*n*f*p,i=l*p+n*f;let H=[],O=[],g=[],y=[];H=[o[0]],O=[o[1]],g=[t[0]],y=[t[1]];let _=polyTermsToHtml,b=mulPolysTerms,v=null,T=null;v=_(b(H,g))+"+"+_(b(H,y))+"+"+_(b(O,g))+"+"+_(b(O,y)),T=resolveHtmlToObj(v),d.push(T),m.push(T.chainHtmlReduce),v=_(b(H,g))+"+"+_(b(O,g))+"+"+_(b(H,y))+"+"+_(b(O,y)),T=resolveHtmlToObj(v),d.push(T),m.push(T.chainHtmlReduce),v=_(H)+"("+_(t)+")+"+_(O)+"("+_(t)+")",T=resolveHtmlToObj(v),h.push(T),a.push(T.chainHtmlReduce),v=_(g)+"("+_(o)+")+"+_(y)+"("+_(o)+")",T=resolveHtmlToObj(v),h.push(T),a.push(T.chainHtmlReduce),v=_(O)+"("+_(t)+")+"+_(H)+"("+_(t)+")",T=resolveHtmlToObj(v),h.push(T),a.push(T.chainHtmlReduce),v=_(y)+"("+_(o)+")+"+_(g)+"("+_(o)+")",T=resolveHtmlToObj(v),h.push(T),a.push(T.chainHtmlReduce),r=copyPolyTerms(o),e=copyPolyTerms(t),r[0].coeff=-1*r[0].coeff,r[1].coeff=-1*r[1].coeff,e[0].coeff=-1*e[0].coeff,e[1].coeff=-1*e[1].coeff,H=[r[0]],O=[r[1]],g=[e[0]],y=[e[1]],v=_(H)+"("+_(e)+")+"+_(O)+"("+_(e)+")",T=resolveHtmlToObj(v),h.push(T),a.push(T.chainHtmlReduce),v=_(g)+"("+_(r)+")+"+_(y)+"("+_(r)+")",T=resolveHtmlToObj(v),h.push(T),a.push(T.chainHtmlReduce),v=_(O)+"("+_(e)+")+"+_(H)+"("+_(e)+")",T=resolveHtmlToObj(v),h.push(T),a.push(T.chainHtmlReduce),v=_(y)+"("+_(r)+")+"+_(g)+"("+_(r)+")",T=resolveHtmlToObj(v),h.push(T),a.push(T.chainHtmlReduce),isPolysEquals(o,t)?(v="("+polyTermsToHtml(o)+")<sup>2</sup>",T=resolveHtmlToObj(v),c.push(T),u.push(T.chainHtmlReduce),v="("+_(o)+")("+_(t)+")",T=resolveHtmlToObj(v),c.push(T),u.push(T.chainHtmlReduce)):(v="("+_(o)+")("+_(t)+")",T=resolveHtmlToObj(v),c.push(T),u.push(T.chainHtmlReduce),v="("+_(t)+")("+_(o)+")",T=resolveHtmlToObj(v),c.push(T),u.push(T.chainHtmlReduce));r=copyPolyTerms(o),e=copyPolyTerms(t),r[0].coeff=-1*r[0].coeff,r[1].coeff=-1*r[1].coeff,e[0].coeff=-1*e[0].coeff,e[1].coeff=-1*e[1].coeff,isPolysEquals(o,t)?(v="("+polyTermsToHtml(r)+")<sup>2</sup>",T=resolveHtmlToObj(v),c.push(T),u.push(T.chainHtmlReduce),v="("+_(r)+")("+_(e)+")",T=resolveHtmlToObj(v),c.push(T),u.push(T.chainHtmlReduce)):(v="("+_(r)+")("+_(e)+")",T=resolveHtmlToObj(v),c.push(T),u.push(T.chainHtmlReduce),v="("+_(e)+")("+_(r)+")",T=resolveHtmlToObj(v),c.push(T),u.push(T.chainHtmlReduce),v="("+_(e.reverse())+")("+_(r)+")",T=resolveHtmlToObj(v),c.push(T))}(),p.poly1Obj=e,p.poly2Obj=l,p.polyObj=n,p.product=s,p.sum=i,p.error="",p.msg="",p.result={},p.step1Html=m,p.step2Html=a,p.step3Html=u,p.step1Equal=d,p.step2Equal=h,p.step3Equal=c,p.step_1_done=O,p.step_2_done=g,p.step_3_done=y,p.steps_AllDone=H},p.analyseStudentInput=function(r,e){let l=r,o={msg:"",error:""};if(0===r.length){let r="";return"step-1"===e?r="l'étape 1":"step-2"===e?r="l'étape 2":"step-3"===e&&(r="l'étape 3"),o.error=errors.empty_div(r),o}if(r.length>=200)return o.error=errors.entryTooBig(),o;let t=(r=>{let e=0,l=0,o="";r.split("").forEach(((r,t)=>{"("===r&&(e+=1),")"===r&&(l+=1,l>e&&""===o&&(o+=errors.para_error(e,l,t)))}));let t=e-l;return""===o&&(t>0?o+=errors.para_close_error(t):t<0&&(t=Math.abs(t),o+=errors.para_open_error(t))),o})(l);if(""!==t)return o.error=t,o;if(t=testStrangeChar(l),""!==t)return o.error=t,o;let p=resolveHtmlToObj(l);if(""!==p.error)return o.error=p.error,o;if(p.special)return o.special=p.special,o;p.repeatedPlusMinus&&(o.msg=msg.sign_repeated()),o.studentObj=p;let H=(r=>{let e=a,l=u,o=-1,t={};return o=m.findIndex((e=>e===r)),-1!==o?(t.find="step-1",t.index=o,t):(o=e.findIndex((e=>e===r)),-1!==o?(t.find="step-2",t.index=o,t):(o=l.findIndex((e=>e===r)),-1!==o?(t.find="step-3",t.index=o,t):(t.find="none",t.index=void 0,t)))})(p.chainHtmlReduce);if(o.result=H,void 0!==H.index){let r,e;return H.index>=4&&"step-2"===H.find&&(r=nbrNegativeSignPolyArrOp(p.polyArrOpToCheck),e=nbrNegativeSignPolyArrOp(h[0].polyArrOpToCheck),r>e&&""===o.msg&&(o.msg=msg.signs_positives(a[0]))),H.index>=2&&"step-3"===H.find&&(r=nbrNegativeSignPolyArrOp(p.polyArrOpToCheck),e=nbrNegativeSignPolyArrOp(c[0].polyArrOpToCheck),r>e&&""===o.msg&&(o.msg=msg.signs_positives(u[0]))),1===H.index&&"step-3"===H.find&&u[0].includes("<sup>")&&(o.msg=msg.prefered_exponent(u[0])),o}if("step-1"===e){let r=(()=>{let r={error:"",msg:""},e=p.polyArrOpToCheck,l=[],o=[],t=d[0].polyArrOpToCheck,a=function(){let r=!0,n=[],s=[];return t.forEach((r=>{r.op?n.push(r):o.push(...r)})),e.forEach((r=>{r.op?s.push(r):l.push(...r)})),s.length===n.length?(n.forEach(((e,l)=>{e.op===s[l].op&&e.level===s[l].level||(r=!1)})),s.forEach(((e,l)=>{e.op===n[l].op&&e.level===n[l].level||(r=!1)}))):r=!1,{ok:r,opStd:s,opProb:n}}(),u=d[0].arrOp[0][0],h=d[0].arrOp[2][0],c=d[0].arrOp[6][0],H=[],O=[],g=0,y=0,_=[];if(l.forEach((r=>{isTermsEquivalent(r,u)&&H.push(r)})),l.forEach((r=>{isTermsEquivalent(r,h)&&O.push(r)})),l.forEach((r=>{isTermsEquivalent(r,c)&&_.push(r)})),1!==H.length)return r.error=errors.nbr_terms_X2_not_equal(H.length,1,u),p.finalHtmlOrder!==n.finalHtmlOrder&&(r.error+=errors.poly_different(p.finalHtmlOrder,n.finalHtmlOrder)),r;if(2!==O.length)return r.error=errors.nbr_terms_X1_not_equal(O.length,2,h),p.finalHtmlOrder!==n.finalHtmlOrder&&(r.error+=errors.poly_different(p.finalHtmlOrder,n.finalHtmlOrder)),r;{g=O[0].coeff,y=O[1].coeff;let e=l.filter((r=>0===r.varArr[0].exponent)),o=0;e.length>0&&e.forEach((r=>{o+=r.coeff}));let t=g*y,f=Math.abs(t),m=Math.abs(s),a=g+y;if(f===m&&a!==i)return r.error=errors.produc_ok_sum_not(g,y),p.finalHtmlOrder!==n.finalHtmlOrder&&(r.error+=errors.poly_different(p.finalHtmlOrder,n.finalHtmlOrder)),r;if(a===i&&f!==m)return r.error=errors.sum_ok_product_not(g,y),p.finalHtmlOrder!==n.finalHtmlOrder&&(r.error+=errors.poly_different(p.finalHtmlOrder,n.finalHtmlOrder)),r;if(a!==i&&f!==m)return r.error=errors.sum_not_product_not(g,y),r;if(a===i&&t===s&&o!==s)return r.error=errors.sum_ok_product_ok_response_not(g,y,o),p.finalHtmlOrder!==n.finalHtmlOrder&&(r.error+=errors.poly_different(p.finalHtmlOrder,n.finalHtmlOrder)),r}return p.finalHtmlOrder!==n.finalHtmlOrder?(console.log("To define ++++++++++++++++++++++++"),r.error+=errors.poly_different(p.finalHtmlOrder,n.finalHtmlOrder),r):a.ok?(p.finalHtml!==d[0].finalHtml&&p.finalHtml!==d[1].finalHtml?r.msg=msg.not_ordered_poly(p.chainHtml,m[0],f):r.msg=msg.better_writing(p.chainHtml,m[0],f),r.find="step-1",4!==l.length?(r.error=errors.nbr_terms(l.length,4),r):(p.finalHtmlOrder!==n.finalHtmlOrder&&(r.error+=errors.poly_different(p.finalHtmlOrder,n.finalHtmlOrder)),r)):a.opStd.length!==a.opProb.length?(r.error=errors.operations_not_equal(a.opStd.length,a.opProb.length),p.finalHtmlOrder!==n.finalHtmlOrder&&(r.error+=errors.poly_different(p.finalHtmlOrder,n.finalHtmlOrder)),r):(r.error=errors.operations_not_same(a.opStd,a.opProb),p.finalHtmlOrder!==n.finalHtmlOrder&&(r.error+=errors.poly_different(p.finalHtmlOrder,n.finalHtmlOrder)),r)})();if(""!==r.msg&&(""===o.msg&&(o.msg=r.msg),o.result=r),""!==r.error)return o.error=r.error,o}else if("step-2"===e){let r=(()=>{let r={error:"",msg:""},e=p.polyArrOpToCheck,l=[],o=[],t=h[0].polyArrOpToCheck,s=function(){let r={index:0,minOpDiff:10,minPolyDiff:10};function t(r){let t=!0,n=[],s=[];return r.forEach((r=>{r.op?n.push(r):o.push(r)})),e.forEach((r=>{r.op?s.push(r):l.push(r)})),s.length===n.length?(n.forEach(((r,e)=>{r.op===s[e].op&&r.level===s[e].level||(t=!1)})),s.forEach(((r,e)=>{r.op===n[e].op&&r.level===n[e].level||(t=!1)}))):t=!1,{ok:t,opStd:s,opProb:n}}for(let l=0;l<h.length;l+=1){let o=h[l].polyArrOpToCheck;if(t(o).ok){let t=isPolysArrOpEquivalents(e,o);(r.minOpDiff>t.nbrOpDiff||r.minPolyDiff>t.nbrPolyDiff)&&(r.index=l,r.minOpDiff=t.nbrOpDiff,r.minPolyDiff=t.nbrPolyDiff)}}return r}();t=h[s.index].polyArrOpToCheck;let i=function(){let r=!0,n=[],s=[];return t.forEach((r=>{r.op?n.push(r):o.push(r)})),e.forEach((r=>{r.op?s.push(r):l.push(r)})),s.length===n.length?(n.forEach(((e,l)=>{e.op===s[l].op&&e.level===s[l].level||(r=!1)})),s.forEach(((e,l)=>{e.op===n[l].op&&e.level===n[l].level||(r=!1)}))):r=!1,{ok:r,opStd:s,opProb:n}}();if(!i.ok)return i.opStd.length!==i.opProb.length?(r.error=errors.operations_not_equal(i.opStd.length,i.opProb.length),p.finalHtmlOrder!==n.finalHtmlOrder&&(r.error+=errors.poly_different(p.finalHtmlOrder,n.finalHtmlOrder)),r):(r.error=errors.operations_not_same(i.opStd,i.opProb),p.finalHtmlOrder!==n.finalHtmlOrder&&(r.error+=errors.poly_different(p.finalHtmlOrder,n.finalHtmlOrder)),r);{let l=isPolysArrOpEquivalents(e,t);if(!l.equal)return r.error=errors.poly_arr_op_not_equivalents(l.nbrOpDiff,l.nbrPolyDiff),p.finalHtmlOrder!==n.finalHtmlOrder&&(r.error+=errors.poly_different(p.finalHtmlOrder,n.finalHtmlOrder)),r;p.finalHtml!==h[0].finalHtml&&p.finalHtml!==h[1].finalHtml&&p.finalHtml!==h[2].finalHtml&&p.finalHtml!==h[3].finalHtml?r.msg=msg.not_ordered_poly(p.chainHtml,a[0],f):r.msg=msg.better_writing(p.chainHtml,a[0],f),r.find="step-2"}return p.finalHtmlOrder!==n.finalHtmlOrder&&(r.error+=errors.poly_different(p.finalHtmlOrder,n.finalHtmlOrder)),r})();if(""!==r.msg&&(""===o.msg&&(o.msg=r.msg),o.result=r),""!==r.error)return o.error=r.error,o}else if("step-3"===e){let r=(()=>{let r={error:"",msg:""},e=p.polyArrOpToCheck,l=[],o=[],t=c[0].polyArrOpToCheck,s=function(){let r={index:0,minOpDiff:10,minPolyDiff:10};function t(r){let t=!0,n=[],s=[];return r.forEach((r=>{r.op?n.push(r):o.push(r)})),e.forEach((r=>{r.op?s.push(r):l.push(r)})),s.length===n.length?(n.forEach(((r,e)=>{r.op===s[e].op&&r.level===s[e].level||(t=!1)})),s.forEach(((r,e)=>{r.op===n[e].op&&r.level===n[e].level||(t=!1)}))):t=!1,{ok:t,opStd:s,opProb:n}}for(let l=0;l<c.length;l+=1){let o=c[l].polyArrOpToCheck;if(t(o).ok){let t=isPolysArrOpEquivalents(e,o);(r.minOpDiff>t.nbrOpDiff||r.minPolyDiff>t.nbrPolyDiff)&&(r.index=l,r.minOpDiff=t.nbrOpDiff,r.minPolyDiff=t.nbrPolyDiff)}}return r}();t=c[s.index].polyArrOpToCheck;let i=function(){let r=!0,n=[],s=[];return t.forEach((r=>{r.op?n.push(r):o.push(r)})),e.forEach((r=>{r.op?s.push(r):l.push(r)})),s.length===n.length?(n.forEach(((e,l)=>{e.op===s[l].op&&e.level===s[l].level||(r=!1)})),s.forEach(((e,l)=>{e.op===n[l].op&&e.level===n[l].level||(r=!1)}))):r=!1,{ok:r,opStd:s,opProb:n}}();if(!i.ok)return i.opStd.length!==i.opProb.length?(r.error=errors.operations_not_equal(i.opStd.length,i.opProb.length),p.finalHtmlOrder!==n.finalHtmlOrder&&(r.error+=errors.poly_different(p.finalHtmlOrder,n.finalHtmlOrder)),r):(r.error=errors.operations_not_same(i.opStd,i.opProb),p.finalHtmlOrder!==n.finalHtmlOrder&&(r.error+=errors.poly_different(p.finalHtmlOrder,n.finalHtmlOrder)),r);{let l=isPolysArrOpEquivalents(e,t);if(!l.equal)return r.error=errors.poly_arr_op_not_equivalents(l.nbrOpDiff,l.nbrPolyDiff),p.finalHtmlOrder!==n.finalHtmlOrder&&(r.error+=errors.poly_different(p.finalHtmlOrder,n.finalHtmlOrder)),r;p.finalHtml!==c[0].finalHtml&&p.finalHtml!==c[1].finalHtml?r.msg=msg.not_ordered_poly(p.chainHtml,u[0],f):r.msg=msg.better_writing(p.chainHtml,u[0],f),r.find="step-3"}return p.finalHtmlOrder!==n.finalHtmlOrder&&(r.error+=errors.poly_different(p.finalHtmlOrder,n.finalHtmlOrder)),r})();if(""!==r.msg&&(""===o.msg&&(o.msg=r.msg),o.result=r),""!==r.error)return o.error=r.error,o}else console.log("Not step for analysing");return o},p};export{ProbFnc};