import errors from"./errors.js";import{termToHtml,htmlToTerm,reduceTerm,orderTermVariables,isTermsEquivalent,isTermsEqual,copyTerm,addTerms,mulTerms}from"./termUtils.js";let supOpen="«",supClose="»";function reduceHtml(e){let r="";r=e,r=r.replace(/&nbsp;/g,""),r=r.replace(/\s/g,"");let o="";for(;o!==r;)o=r,r=r.split("--").join("+"),r=r.split("++").join("+"),r=r.split("+-").join("-"),r=r.split("-+").join("-");return o}function repeatedPlusMinus(e){let r="",o=!1;r=e,r=r.replace(/&nbsp;/g,""),r=r.replace(/\s/g,"");let l="";for(;l!==r;)l=r,r=r.split("--").join("+"),r=r.split("++").join("+"),r=r.split("+-").join("-"),r=r.split("-+").join("-"),l!==r&&(o=!0);return o}function isNotAcceptedChar(e){return!new RegExp("[A-Za-z\\s\\d-+*()]","ig").test(e)}function testStrangeChar(e){let r="",o=e;o=o.replace(/<sup>/gi,""),o=o.replace(/<\/sup>/gi,"");let l=o.split("").findIndex(((e,r)=>isNotAcceptedChar(e)));if(-1!==l){let e=0;for(let r=0;r<l;r+=1)o[r]===supOpen&&(e+=1),o[r]===supClose&&(e+=1);r=errors.char_not_allowed(o[l],l-e)}return r}function isDigit(e){return/[-\d]/.test(e)}function isNumber(e){return/[\d]/.test(e)}function isLetter(e){return/[a-zA-Z]/.test(e)}function mulPolysTerms(e,r){let o=[];return e.forEach((e=>{r.forEach((r=>{o.push(mulTerms(e,r))}))})),o}function exponentPolysTerms(e,r){copyPolyTerms(e);let o=r[0].coeff;function l(e,r){let o=[];return e.forEach((e=>{r.forEach((r=>{o.push(mulTerms(e,r))}))})),o}if(1===o)return e;if(0===o)return[{coeff:1,varArr:[{variable:"x",exponent:0}]}];if(2===o){return l(e,e)}if(o>2){let r=l(e,e);for(let t=o;t>2;t-=1)r=l(r,e);return r}return[]}function orderPolyDescr(e,r){let o=copyPolyTerms(e);return o.sort(((e,r)=>{let o=0,l=0;return e.varArr.forEach((e=>o+=e.exponent)),r.varArr.forEach((e=>l+=e.exponent)),o>l?-1:o<l?1:e.coeff>r.coeff?-1:e.coeff<r.coeff?1:0})),o.forEach((e=>{e.varArr.sort(((e,r)=>e.variable<r.variable?-1:e.variable>r.variable?1:0))})),o}function orderPolyOpDescr(e,r){let o=copyPolyTerms(e);return o.forEach((e=>{e.varArr.sort(((e,r)=>e.variable<r.variable?-1:e.variable>r.variable?1:0))})),o.sort(((e,r)=>{let o=0,l=0;return e.varArr.forEach((e=>o+=e.exponent)),r.varArr.forEach((e=>l+=e.exponent)),l-o})),o}function polyTermsToHtml(e){let r="";return e.forEach(((e,o)=>{let l=0;e.varArr.forEach((e=>{l+=e.exponent})),0===l?e.coeff>0?r+=0===o?e.coeff:"+"+e.coeff:r+=e.coeff:e.coeff>1?r+=0===o?e.coeff:"+"+e.coeff:1===e.coeff?0!==o&&(r+="+"):-1===e.coeff?r+="-":r+=e.coeff,e.varArr.forEach((e=>{e.exponent>0&&(r+=e.variable,e.exponent>1&&(r+=`<sup>${e.exponent}</sup>`))}))})),reduceHtml(r)}function addPolysTerms(e,r){let o=[];for(let r=0;r<e.length;r++)o.push(e[r]);for(let e=0;e<r.length;e++)o.push(r[e]);return o=reducePolyTerms(o),o}function copyPolyTerms(e){return JSON.parse(JSON.stringify(e))}function reducePolyTerms(e){let r=copyPolyTerms(e),o=[];o.push(r[0]);for(let e=1;e<r.length;e++){let l=!1;for(let t=0;t<o.length;t++)isTermsEquivalent(o[t],r[e])&&(o[t].coeff=o[t].coeff+r[e].coeff,l=!0);l||o.push(r[e])}let l=[];for(let e=0;e<o.length;e++)0!==o[e].coeff&&l.push(o[e]);return l}function transformHtmlToOP(e){let r={msg:"",error:""};r.chainHtml=e,r.chainHtmlReduce=reduceHtml(e.toLowerCase()),r.repeatedPlusMinus=repeatedPlusMinus(e.toLowerCase());let o=reduceHtml(e.toLowerCase()),l=o.split("-").join("+-").replace(/<sup>/gi,supOpen);l=l.replace(/<\/sup>/gi,supClose);let t=l.split("");o=t;let p=!1,s=0,i=[],n=0;t.forEach(((e,r)=>{e===supOpen&&(p=!0),t[r-1]===supClose&&(p=!1),((e,r,o=!1)=>{if(o)i.push({char:e,op:"no",level:n,index:r,modeSup:o});else{if("+"===e)return 0===r||"("===t[r-1]?void 0:void i.push({char:e,op:"+",level:n,index:r,modeSup:o});if("("===e)return n++,s=Math.max(s,n),"*"===t[r-1]||"+"===t[r-1]||0===r||"("===t[r-1]?void 0:void i.push({char:"*",op:"*",level:n-1,index:r,modeSup:o});if(")"===e)return n--,"+"===t[r+1]||r===t.length-1||")"===t[r+1]||"*"===t[r+1]||"("===t[r+1]?void 0:t[r+1]&&t[r+1]===supOpen?void i.push({char:"^",op:"^",level:n,index:r,modeSup:o}):void i.push({char:"*",op:"*",level:n,index:r,modeSup:o});if("*"!==e)return isLetter(e)&&t[r-1]&&isNumber(t[r+1])?(i.push({char:e,op:"no",level:n,index:r,modeSup:o}),void i.push({char:"*",op:"*",level:n,index:r,modeSup:o})):(isNumber(e)||isLetter(e))&&t[r-1]&&t[r-1]===supClose||isLetter(e)&&t[r-1]&&isLetter(t[r-1])?(i.push({char:"*",op:"*",level:n,index:r,modeSup:o}),void i.push({char:e,op:"no",level:n,index:r,modeSup:o})):void i.push({char:e,op:"no",level:n,index:r,modeSup:o});i.push({char:e,op:"*",level:n,index:r,modeSup:o})}})(e,r,p)})),r.chainOp=i.map((e=>e.char)).join("");let a="",u=[];i.forEach((e=>{"no"===e.op?a+=e.char:(u.push(a),u.push(e),a="")})),""!==a?u.push(a):u.push(""),r.testOp=u;let f=1,c=[],h=Array.from(new Array(s+1),(()=>new Array));u.forEach((e=>{"+"!==e.op&&"*"!==e.op&&"^"!==e.op||c.push(e)}));for(let e=s;e>=0;e--){let r=[];for(let o=0;o<c.length;o++)c[o].level===e&&(r.push(c[o]),c[o+1]&&c[o+1].level!==e?(h[e].push(r),r=[]):(c[o+1],h[e].push(r),r=[]))}for(let e=s;e>=0;e--)u.forEach((r=>{"^"===r.op&&r.level===e&&(r.priority=f++)})),u.forEach((r=>{"*"===r.op&&r.level===e&&(r.priority=f++)})),u.forEach((r=>{"+"===r.op&&r.level===e&&(r.priority=f++)}));let m=1/0,y=0,d=JSON.parse(JSON.stringify(u)),v=d.map(((e,o)=>{if("+"===e.op||"*"===e.op||"^"===e.op)return e;{let l=e.replace(`/${supOpen}/ig`,"<sup>").replace(`/${supClose}/ig`,"</sup>"),t=o===d.length-1||d[o+1]&&"+"===d[o+1].op||d[o-1]&&d[o+1]&&d[o-1].level!==d[o+1].level?htmlToTerm(l,!0):htmlToTerm(l);return""!==t.error&&(r.error+=t.error),[t]}}));if(""!==r.error)return r.error+=errors.end(),r;return r.arrOp=JSON.parse(JSON.stringify(v)),r.nbrLevel=s,r.copyTerms=JSON.parse(JSON.stringify(v)),function(e){let o=JSON.parse(JSON.stringify(e)),l=e=>{if((e=>{m=1/0,y=0,o.forEach((r=>{r.level===e&&(m=Math.min(m,r.priority),y=Math.max(y,r.priority))}))})(e),m===1/0)return"done";for(let e=0;e<o.length;e++){let l=o[e];if(l.priority===m){let t=o[e-1],p=o[e+1];"^"===l.op?(t.length>1?2===t.length?p[0].coeff>10&&(r.specialOperand="Exponent is too high!!!!!!!!",r.poly1Length=t.length,r.expo=p[0].coeff):3===t.length?p[0].coeff>5&&(r.specialOperand="Exponent is too high!!!!!!!!",r.poly1Length=t.length,r.expo=p[0].coeff):(r.specialOperand="Poly too big to expose !!!!!!!!!!!",r.poly1Length=t.length,r.expo=p[0].coeff):p[0].coeff>1e4&&(r.specialOperand="Exponent is too high!!!!!!!!",r.poly1Length=t.length,r.expo=p[0].coeff),o.splice(e-1,3,addPolysTerms(t,p))):("*"===l.op||"+"===l.op)&&o.splice(e-1,3,addPolysTerms(t,p));break}}},t=[];for(let e=s;e>=0;e--){for(;"done"!==l(e);)l(e);t.push(JSON.parse(JSON.stringify(o)))}}(v),r}function resolveHtmlToObj(e){let r={msg:"",error:""},o=transformHtmlToOP(e);if(r=Object.assign(r,o),""!==r.error)return r;if(r.specialOperand)return r.special=errors.specialCases(r.poly1Length,r.expo),r;let l=r.nbrLevel,t=r.copyTerms,p=1/0,s=0,i=e=>{if((e=>{p=1/0,s=0,t.forEach((r=>{r.level===e&&(p=Math.min(p,r.priority),s=Math.max(s,r.priority))}))})(e),p===1/0)return"done";for(let e=0;e<t.length;e++){let r=t[e];if(r.priority===p){let o=t[e-1],l=t[e+1];"^"===r.op?t.splice(e-1,3,exponentPolysTerms(o,l)):"*"===r.op?t.splice(e-1,3,mulPolysTerms(o,l)):"+"===r.op&&t.splice(e-1,3,addPolysTerms(o,l));break}}},n=[];for(let e=l;e>=0;e--){for(;"done"!==i(e);)i(e);n.push(JSON.parse(JSON.stringify(t)))}let a=reducePolyTerms(t[0]);n.push(a),r.nbrLevel=l,r.arrAllResLevels=n,r.finalHtml=polyTermsToHtml(n[l+1]),r.finalHtml=polyTermsToHtml(n[l+1]),r.finalPoly=n[l+1],r.finalHtmlReduce=polyTermsToHtml(r.finalPoly);let u=[];return u=0===l?r.arrOp:r.arrAllResLevels[0],r.polyArrOpToCheck=u,r.finalPolyOrder=orderPolyDescr(r.finalPoly),r.finalHtmlOrder=polyTermsToHtml(r.finalPolyOrder),r}function resolveHtmlToObj_backup(e){let r={msg:"",error:""};r.chainHtml=e,r.chainHtmlReduce=reduceHtml(e.toLowerCase()),r.repeatedPlusMinus=repeatedPlusMinus(e.toLowerCase());let o=reduceHtml(e.toLowerCase()),l=o.split("-").join("+-").replace(/<sup>/gi,supOpen);l=l.replace(/<\/sup>/gi,supClose);let t=l.split("");o=t;let p=!1,s=0,i=[],n=0;t.forEach(((e,r)=>{e===supOpen&&(p=!0),t[r-1]===supClose&&(p=!1),((e,r,o=!1)=>{if(o)i.push({char:e,op:"no",level:n,index:r,modeSup:o});else{if("+"===e)return 0===r||"("===t[r-1]?void 0:void i.push({char:e,op:"+",level:n,index:r,modeSup:o});if("("===e)return n++,s=Math.max(s,n),"*"===t[r-1]||"+"===t[r-1]||0===r||"("===t[r-1]?void 0:void i.push({char:"*",op:"*",level:n-1,index:r,modeSup:o});if(")"===e)return n--,"+"===t[r+1]||r===t.length-1||")"===t[r+1]||"*"===t[r+1]||"("===t[r+1]?void 0:t[r+1]&&t[r+1]===supOpen?void i.push({char:"^",op:"^",level:n,index:r,modeSup:o}):void i.push({char:"*",op:"*",level:n,index:r,modeSup:o});if("*"!==e)return isLetter(e)&&t[r-1]&&isNumber(t[r+1])?(i.push({char:e,op:"no",level:n,index:r,modeSup:o}),void i.push({char:"*",op:"*",level:n,index:r,modeSup:o})):(isNumber(e)||isLetter(e))&&t[r-1]&&t[r-1]===supClose||isLetter(e)&&t[r-1]&&isLetter(t[r-1])?(i.push({char:"*",op:"*",level:n,index:r,modeSup:o}),void i.push({char:e,op:"no",level:n,index:r,modeSup:o})):void i.push({char:e,op:"no",level:n,index:r,modeSup:o});i.push({char:e,op:"*",level:n,index:r,modeSup:o})}})(e,r,p)})),r.chainOp=i.map((e=>e.char)).join("");let a="",u=[];i.forEach((e=>{"no"===e.op?a+=e.char:(u.push(a),u.push(e),a="")})),""!==a?u.push(a):u.push(""),r.testOp=u;let f=1,c=[],h=Array.from(new Array(s+1),(()=>new Array));u.forEach((e=>{"+"!==e.op&&"*"!==e.op&&"^"!==e.op||c.push(e)}));for(let e=s;e>=0;e--){let r=[];for(let o=0;o<c.length;o++)c[o].level===e&&(r.push(c[o]),c[o+1]&&c[o+1].level!==e?(h[e].push(r),r=[]):(c[o+1],h[e].push(r),r=[]))}for(let e=s;e>=0;e--)u.forEach((r=>{"^"===r.op&&r.level===e&&(r.priority=f++)})),u.forEach((r=>{"*"===r.op&&r.level===e&&(r.priority=f++)})),u.forEach((r=>{"+"===r.op&&r.level===e&&(r.priority=f++)}));let m=1/0,y=0,d=JSON.parse(JSON.stringify(u)),v=d.map(((e,o)=>{if("+"===e.op||"*"===e.op||"^"===e.op)return e;{let l=e.replace(`/${supOpen}/ig`,"<sup>").replace(`/${supClose}/ig`,"</sup>"),t=o===d.length-1||d[o+1]&&"+"===d[o+1].op||d[o-1]&&d[o+1]&&d[o-1].level!==d[o+1].level?htmlToTerm(l,!0):htmlToTerm(l);return""!==t.error&&(r.error+=t.error),[t]}}));if(""!==r.error)return r.error+=errors.end(),r;r.arrOp=JSON.parse(JSON.stringify(v));let g=e=>{if((e=>{m=1/0,y=0,v.forEach((r=>{r.level===e&&(m=Math.min(m,r.priority),y=Math.max(y,r.priority))}))})(e),m===1/0)return"done";for(let e=0;e<v.length;e++){let r=v[e];if(r.priority===m){let o=v[e-1],l=v[e+1];"^"===r.op?v.splice(e-1,3,exponentPolysTerms(o,l)):"*"===r.op?v.splice(e-1,3,mulPolysTerms(o,l)):"+"===r.op&&v.splice(e-1,3,addPolysTerms(o,l));break}}},T=[];for(let e=s;e>=0;e--){for(;"done"!==g(e);)g(e);T.push(JSON.parse(JSON.stringify(v)))}let O=reducePolyTerms(v[0]);T.push(O),r.nbrLevel=s,r.arrAllResLevels=T,r.finalHtml=polyTermsToHtml(T[s+1]),r.finalHtml=polyTermsToHtml(T[s+1]),r.finalPoly=T[s+1],r.finalHtmlReduce=polyTermsToHtml(r.finalPoly);let P=[];return P=0===s?r.arrOp:r.arrAllResLevels[0],r.polyArrOpToCheck=P,r.finalPolyOrder=orderPolyDescr(r.finalPoly),r.finalHtmlOrder=polyTermsToHtml(r.finalPolyOrder),r}function isPolysEquals(e,r){let o=copyPolyTerms(e),l=copyPolyTerms(r),t=!0;return o.length===l.length&&(o.forEach(((e,r)=>{isTermsEqual(e,l[r])||(t=!1)})),t)}function isPolysEquivalents(e,r){let o=orderPolyDescr(e),l=orderPolyDescr(r),t=!0;return o.length===l.length&&(o.forEach(((e,r)=>{isTermsEqual(e,l[r])||(t=!1)})),t)}function isPolysArrOpEquals(e,r){let o=copyPolyTerms(e),l=copyPolyTerms(r),t=!0;return o.length===l.length&&(o.forEach(((e,r)=>{!e.op||e.op===l[r].op&&e.level===l[r].level&&e.priority===l[r].priority||(t=!1)})),t&&o.forEach(((e,r)=>{Array.isArray(e)&&(Array.isArray(l[r])?JSON.stringify(e)!==JSON.stringify(l[r])&&(t=!1):t=!1)})),t)}function isPolysArrOpEquivalents(e,r){let o=copyPolyTerms(e),l=copyPolyTerms(r),t=!0,p=0,s=0,i=[],n=[];o.forEach(((e,r)=>{e.op&&i.push(e)})),l.forEach(((e,r)=>{e.op&&n.push(e)})),i.forEach(((e,r)=>{!e.op||e.op===n[r].op&&e.level===n[r].level&&e.priority===n[r].priority||(t=!1,p+=1)})),n.length>i.length&&(p+=n.length-i.length);let a=[];return o.forEach(((e,r)=>{if(Array.isArray(e)){let r=!1;for(let o=0;o<l.length;o+=1)Array.isArray(l[o])&&isPolysEquals(orderPolyOpDescr(e),orderPolyDescr(l[o]))&&(a.includes[o]||(r=!0,a.push(o)));r||(t=!1,s+=1)}})),{equal:t,nbrOpDiff:p,nbrPolyDiff:s}}function nbrNegativeSignPolyArrOp(e){let r=0;function o(e){let r=0;return e.forEach((e=>{r+=e.exponent})),r}return e.forEach((e=>{if(Array.isArray(e))for(let l=0;l<e.length;l+=1)o(e[l].varArr)>0&&e[l].coeff<0&&(r+=1)})),r}export{resolveHtmlToObj,polyTermsToHtml,mulPolysTerms,copyPolyTerms,testStrangeChar,isPolysEquals,isPolysEquivalents,isPolysArrOpEquals,isPolysArrOpEquivalents,nbrNegativeSignPolyArrOp};